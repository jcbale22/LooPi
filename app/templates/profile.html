{% extends "base.html" %}
{% block title %}Your Profile{% endblock %}

{% block content %}
{% if message %}
  <script>showToast("{{ message }}", "success")</script>
{% elif error %}
  <script>showToast("{{ error }}", "error")</script>
{% endif %}

<div style="display: flex; justify-content: center;">
  <div class="card-profile" style="max-width: 960px;">
    <h1 style="margin-bottom: 16px; text-align: center;">My Profile</h1>

    <!-- User Info -->
    <div class="card-section card-profile-info">
      <div style="position: relative; width: 100px; height: 100px;">
        {% if user.avatar_url %}
          <img src="{{ user.avatar_url }}" alt="Avatar" class="avatar-lg" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 2px solid #ccc;">
        {% else %}
          <div class="initials-avatar" style="width: 100px; height: 100px; border-radius: 50%; background: #ccc; display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: bold; border: 2px solid #aaa;">
            {{ user.name.split()[0][0] }}{{ user.name.split()[-1][0] }}
          </div>
        {% endif %}
        <button class="icon-btn" title="Edit Avatar" style="position:absolute; bottom:4px; right:4px; background:#fff; border-radius:50%; padding:4px; border: 1px solid #ccc;">
          <img src="/static/icons/lucide/pencil.svg" width="16" height="16" alt="Edit" />
        </button>
      </div>
      <div class="profile-meta">
        <h2>{{ user.name }}</h2>

        <div id="email-display" style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
          <span class="pill pill-small">{{ user.email or 'n/a' }}</span>
          <button class="icon-btn" onclick="toggleEmailEdit(true)">
            <img src="/static/icons/lucide/pencil.svg" width="16" height="16" alt="Edit" />
          </button>
        </div>

        <form id="email-form" action="/profile/update-email" method="post" style="display: none; flex-wrap: nowrap; align-items: center; gap: 8px; margin-bottom: 4px;">
          <input type="email" name="email" value="{{ user.email or '' }}" required class="pill pill-small" style="padding: 6px 10px; min-width: 200px; border: 1px solid #ccc;">
          <button type="submit" class="icon-btn">
            <img src="/static/icons/lucide/check.svg" width="16" height="16" alt="Save" />
          </button>
          <button type="button" class="icon-btn" onclick="toggleEmailEdit(false)">
            <img src="/static/icons/lucide/x.svg" width="16" height="16" alt="Cancel" />
          </button>
        </form>

        <p>Role: <span class="pill pill-small" style="background:#eee;">{{ user.role or 'Admin' }}</span></p>
      </div>
    </div>

    <!-- Spacer below user info -->
    <div style="height: 32px;"></div>

    <!-- Actions -->
    <div class="card-section" style="padding-bottom: 24px;">
      <h3>Manage Your Account</h3>
      <ul class="account-links">
        <li>
          <a class="btn-link" href="#">
            <img src="/static/icons/lucide/lock.svg" width="18" style="margin-right:6px; vertical-align:middle;" />
            Change Password
          </a>
        </li>
        <li>
          <a class="btn-link" href="/subscription">
            <img src="/static/icons/lucide/credit-card.svg" width="18" style="margin-right:6px; vertical-align:middle;" />
            Manage Subscription
          </a>
        </li>
        <li>
          <a class="btn-link" href="#">
            <img src="/static/icons/lucide/download.svg" width="18" style="margin-right:6px; vertical-align:middle;" />
            Export Data
          </a>
        </li>
        <li>
          <form action="/logout" method="post" style="display:inline;">
            <button type="submit" class="btn-link">
              <img src="/static/icons/lucide/log-out.svg" width="18" style="margin-right:6px; vertical-align:middle;" />
              Sign Out
            </button>
          </form>
        </li>
      </ul>
    </div>

    <!-- Time Preferences -->
    <div class="card-section">
      <h3>Time Display Preferences</h3>
      <form action="/profile/time-settings" method="post" class="form-grid" style="max-width: 400px; margin-top: 16px;">
        <label for="time_format">Clock Format:</label>
        <select name="time_format" id="time_format" style="padding:8px 12px; border-radius: 6px; border: 1px solid #ccc;">
          <option value="12" {% if user.time_format == '12' %}selected{% endif %}>12-hour</option>
          <option value="24" {% if user.time_format == '24' %}selected{% endif %}>24-hour</option>
        </select>

        <label for="timezone">Time Zone:</label>
        <select name="timezone" id="timezone" style="padding:8px 12px; border-radius: 6px; border: 1px solid #ccc;">
          <option value="">-- Choose Time Zone --</option>
          <option value="UTC" {% if user.timezone == 'UTC' %}selected{% endif %}>UTC</option>
          <option value="America/New_York" {% if user.timezone == 'America/New_York' %}selected{% endif %}>Eastern (US)</option>
          <option value="America/Chicago" {% if user.timezone == 'America/Chicago' %}selected{% endif %}>Central (US)</option>
          <option value="America/Denver" {% if user.timezone == 'America/Denver' %}selected{% endif %}>Mountain (US)</option>
          <option value="America/Los_Angeles" {% if user.timezone == 'America/Los_Angeles' %}selected{% endif %}>Pacific (US)</option>
        </select>

        <button type="submit" class="btn btn-primary" style="margin-top: 12px;">ðŸ’¾ Save Preferences</button>
      </form>
    </div>
  </div>
</div>

<!-- Avatar Upload Modal -->
<div id="avatarModal" class="modal hidden">
  <div class="modal-content">
    <h2>Upload New Avatar</h2>
    <form action="/profile/avatar-upload" method="post" enctype="multipart/form-data">
      <input type="file" name="avatar" accept="image/*" required style="margin-bottom: 12px;" />
      <div class="modal-actions">
        <button type="submit" class="btn btn-primary">Upload</button>
        <button type="button" class="btn" onclick="closeAvatarModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<script>
  document.querySelector('.icon-btn')?.addEventListener('click', () => {
    document.getElementById('avatarModal')?.classList.remove('hidden');
  });

  function closeAvatarModal() {
    document.getElementById('avatarModal')?.classList.add('hidden');
  }

  function toggleEmailEdit(showEdit) {
    document.getElementById('email-display').style.display = showEdit ? 'none' : 'flex';
    document.getElementById('email-form').style.display = showEdit ? 'flex' : 'none';
  }
</script>

{% endblock %}
